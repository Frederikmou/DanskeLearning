@using Core.Models
@using DanskeLearning.Components
@using DanskeLearning.Services.ArticleService
@using DanskeLearning.Services.TestService
@using DanskeLearning.Services.UserSessionService
@inject IUserSessionService UserSession
@inject Services.ArticleReadStatusService.IArticleReadStatusService ArticleReadStatusService
@inject IArticlesService ArticleService
@inject ITestService TestService
@inject NavigationManager NavManager
@page "/ArticlePage/{subjectId:int}"

<div class="articlepage-container">

    <h1 class="articlepage-title">Artikler</h1>

    @if (articles == null)
    {
        <p class="empty-message">Indlæser...</p>
    }
    else if (articles.Count == 0)
    {
        <p class="empty-message">Ingen artikler for dette emne.</p>
    }
    else
    {
        <div class="articles-grid">
            @foreach (var a in articles)
            {
                <ArticleComponent Article="a" IsRead="@(readMap.ContainsKey(a.articleId) && readMap[a.articleId])"/>
            }
        </div>
    }

    <h2 class="test-header">Test</h2>

    <div class="test-section">
        <div class="test-card @(testCompleted ? "completed" : "")" @onclick="StartTest">
            Test
        </div>
    </div>

</div>

@code {
    [Parameter] public int subjectId { get; set; }

    private List<Articles>? articles;
    
    private Dictionary<int, bool> readMap = new();
    
    private bool testCompleted = false;

    protected override async Task OnInitializedAsync()
    {
        await UserSession.InitializeAsync();
        articles = await ArticleService.GetArticlesByIdAsync(subjectId);
        
        testCompleted = await TestService.GetTestCompleted(
            UserSession.CurrentUser.UserId, 
            subjectId
        );

        var userId = UserSession.CurrentUser.UserId;

        readMap = new Dictionary<int, bool>();

        foreach (var a in articles)
        {
            bool isRead = await ArticleReadStatusService.GetReadStatusAsync(userId, a.articleId);
            readMap[a.articleId] = isRead;
        }
    }

    private void StartTest()
    {
        NavManager.NavigateTo($"/test/{subjectId}");
    }
}

